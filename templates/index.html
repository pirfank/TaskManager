<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<!-- Notification sound -->
<audio id="notifySound">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<!-- Top-right buttons -->
<div class="top-buttons">
    <button onclick="toggleDark()">ğŸŒ™</button>
    <button onclick="requestNotify()">ğŸ””</button>
</div>

<div class="content">
    <h1>Task Manager</h1>

    <div class="card">
        <h2>Add New Task</h2>
        <form method="POST" class="add-task-form">
            <input type="text" name="content" placeholder="Enter task..." required>
            <input type="datetime-local" name="due_time" required>
            <input type="submit" value="Add">
        </form>
    </div>

    <div class="card">
        <h2>Your Tasks</h2>

        {% for task in tasks %}
        {% set diff = (task.due_time - now).total_seconds() %}
        {% set days = (diff // 86400)|int %}
        {% set hours = ((diff % 86400) // 3600)|int %}
        {% set minutes = ((diff % 3600) // 60)|int %}

        <div class="task-card {% if task.is_overdue() %}overdue{% endif %}"
             data-task="{{ task.content }}"
             data-time="{{ task.due_time.isoformat() }}">

            <div>
                <strong>{{ task.content }}</strong>
                <div class="time">
                    {{ task.due_time.strftime('%Y-%m-%d %H:%M') }}

                    {% if diff <= 0 %}
                        <span class="countdown overdue-text">(overdue)</span>

                    {% elif days >= 1 %}
                        <span class="countdown">
                            (in {{ days }}d {{ hours }}h {{ minutes }}m)
                        </span>

                    {% else %}
                        <span class="countdown">
                            (in {{ hours }}h {{ minutes }}m)
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="actions">
                <a href="/update/{{ task.id }}" class="btn warn">Edit</a>
                <a href="/delete/{{ task.id }}" class="btn danger">Delete</a>
            </div>
        </div>

        {% else %}
        <p class="empty">No tasks yet ğŸ‘‹</p>
        {% endfor %}
    </div>
</div>

<script>
/* ================= DARK MODE (PERSISTENT) ================= */
function applySavedTheme() {
    if (localStorage.getItem("darkMode") === "on") {
        document.body.classList.add("dark");
    }
}

function toggleDark() {
    document.body.classList.toggle("dark");
    localStorage.setItem(
        "darkMode",
        document.body.classList.contains("dark") ? "on" : "off"
    );
}

applySavedTheme();

/* ================= NOTIFICATIONS + SOUND ================= */
function requestNotify() {
    if ("Notification" in window) {
        Notification.requestPermission();
    }
}

function checkTasks() {
    if (Notification.permission !== "granted") return;

    const sound = document.getElementById("notifySound");

    document.querySelectorAll(".task-card").forEach(card => {
        if (card.dataset.notified) return;

        const due = new Date(card.dataset.time);
        const now = new Date();

        if (now >= due) {
            new Notification("â° Task Due", {
                body: card.dataset.task
            });
            sound.play().catch(() => {});
            card.dataset.notified = "true";
        }
    });
}

setInterval(checkTasks, 30000);
</script>

</body>
</html>

