<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body class="dark">

<!-- TOP ACTIONS -->
<div class="top-actions">
    <button id="themeToggle"><i class="fa-solid fa-moon"></i></button>
    <button id="enableNotify"><i class="fa-solid fa-bell"></i></button>
    <a href="/logout"><i class="fa-solid fa-right-from-bracket"></i></a>
</div>

<div class="app-container">
    <h1>Task Manager</h1>

    <!-- ADD TASK -->
    <div class="card">
        <h2>Add New Task</h2>
        <form method="POST" class="add-task-form">
            <input type="text" name="content" placeholder="Enter task..." required>
            <input type="datetime-local" name="due_time" required>
            <button class="btn primary">Add</button>
        </form>
    </div>

    <!-- TASK LIST -->
    <div class="card">
        <h2>Your Tasks</h2>

        {% if tasks|length == 0 %}
            <p class="empty">No tasks yet ðŸ‘‹</p>
        {% else %}
            {% for task in tasks %}
                <div class="task-item {% if task.is_overdue() %}overdue{% endif %}"
                     data-id="{{ task.id }}"
                     data-time="{{ task.due_time.timestamp() }}">

                    <div class="task-info">
                        <div class="task-title">{{ task.content }}</div>
                        <div class="task-time" id="time-{{ task.id }}"></div>
                    </div>

                    <div class="task-actions">
                        <a href="/update/{{ task.id }}" class="btn warning">Edit</a>
                        <a href="/delete/{{ task.id }}" class="btn danger">Delete</a>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<!-- AUDIO -->
<audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<script>
/* ===== THEME ===== */
document.getElementById("themeToggle").onclick = () =>
    document.body.classList.toggle("dark");

/* ===== NOTIFICATION PERMISSION ===== */
document.getElementById("enableNotify").onclick = async () => {
    await Notification.requestPermission();
};

/* ===== REMINDER + COUNTDOWN ENGINE ===== */
const fired = new Set();
const beep = document.getElementById("beep");

function formatRemaining(seconds) {
    if (seconds < 0) {
        seconds = Math.abs(seconds);
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `âš ï¸ Overdue by ${m}m ${s}s`;
    }

    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;

    if (h > 0) return `â³ ${h}h ${m}m ${s}s remaining`;
    if (m > 0) return `â³ ${m}m ${s}s remaining`;
    return `â³ ${s}s remaining`;
}

setInterval(() => {
    const now = Math.floor(Date.now() / 1000);

    document.querySelectorAll(".task-item").forEach(task => {
        const due = parseInt(task.dataset.time);
        const id = task.dataset.id;
        const diff = due - now;

        // update countdown text
        document.getElementById(`time-${id}`).innerText =
            formatRemaining(diff);

        // fire notification once
        if (diff <= 0 && !fired.has(id)) {
            fired.add(id);

            beep.currentTime = 0;
            beep.play();

            if (Notification.permission === "granted") {
                new Notification("â° Task Due", {
                    body: task.querySelector(".task-title").innerText
                });
            }
        }
    });
}, 1000);
</script>

</body>
</html>
